//
//  editProfile.swift
//  SOZIP
//
//  Created by ÌïòÏ∞ΩÏßÑ on 2021/08/11.
//

import SwiftUI

struct editProfileView: View {
    @State private var nickName = ""
    @State private var isNickNameEditing = false
    
    @State private var showAlert = false
    @State private var alertModel : More_AlertModel?
    @State private var showSignInScreen = false
    
    @State private var profile = ""
    @State private var profile_bg : Color = .sozip_bg_1
    
    @State private var showProcess = false
    
    @EnvironmentObject var helper : UserManagement
    
    var body: some View {
        ZStack{
            Color.backgroundColor.edgesIgnoringSafeArea(.all)
            
            ScrollView{
                
                VStack{
                    Group {
                        Spacer().frame(height : 15)
                        
                        Text(profile)
                            .font(.system(size: 50, weight: .semibold))
                            .background(Circle()
                                .foregroundColor(profile_bg)
                                .frame(width : 100, height : 100)
                                .shadow(color: .gray, radius: /*@START_MENU_TOKEN@*/10/*@END_MENU_TOKEN@*/, x: /*@START_MENU_TOKEN@*/0.0/*@END_MENU_TOKEN@*/, y: /*@START_MENU_TOKEN@*/0.0/*@END_MENU_TOKEN@*/))
                        
                        Spacer().frame(height : 30)
                        
                        Text(helper.name)
                            .fontWeight(.semibold)
                            .foregroundColor(.txt_color)
                        
                        Spacer().frame(height : 20)
                        
                        HStack{
                            Text("ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω")
                                .font(.caption)
                                .foregroundColor(.gray)
                            
                            Spacer()
                        }
                        
                        Spacer().frame(height : 10)
                        
                        HStack {
                            Image(systemName: "person.fill")
                            
                            TextField("ÎãâÎÑ§ÏûÑ", text:$nickName, onEditingChanged: {(editing) in
                                if editing{
                                    isNickNameEditing = true
                                }
                                
                                
                                else{
                                    isNickNameEditing = false
                                }
                                
                            })
                        }
                        .foregroundColor(isNickNameEditing ? Color.accent : Color.txt_color)
                        .padding(20)
                        .padding([.horizontal], 20)
                        .background(RoundedRectangle(cornerRadius: 10).foregroundColor(.btn_color).shadow(radius: 5)
                            .padding([.horizontal],15))
                        
                        Spacer().frame(height : 20)
                        
                        HStack{
                            Text("ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï")
                                .font(.caption)
                                .foregroundColor(.gray)
                            
                            Spacer()
                        }
                    }
                    
                    Spacer().frame(height : 10)
                    
                    Group {
                        Spacer().frame(height : 20)
                        
                        HStack{
                            Button(action: {
                                profile = "üê∑"
                            }){
                                Text("üê∑")
                                    .font(.largeTitle)
                                    .fontWeight(.semibold)
                                    .padding(5)
                                    .background(Circle()
                                        .strokeBorder(lineWidth: 3, antialiased: /*@START_MENU_TOKEN@*/true/*@END_MENU_TOKEN@*/)
                                        .isHidden(profile != "pig" && profile != "üê∑")
                                    )
                            }
                            
                            Spacer().frame(width : 20)
                            
                            Button(action: {
                                profile = "üê∞"
                            }){
                                Text("üê∞")
                                    .font(.largeTitle)
                                    .fontWeight(.semibold)
                                    .padding(5)
                                    .background(Circle()
                                        .strokeBorder(lineWidth: 3, antialiased: /*@START_MENU_TOKEN@*/true/*@END_MENU_TOKEN@*/)
                                        .isHidden(profile != "rabbit" && profile != "üê∞")
                                    )
                            }
                            
                            Spacer().frame(width : 20)
                            
                            Button(action: {
                                profile = "üêØ"
                            }){
                                Text("üêØ")
                                    .font(.largeTitle)
                                    .fontWeight(.semibold)
                                    .padding(5)
                                    .background(Circle()
                                        .strokeBorder(lineWidth: 3, antialiased: /*@START_MENU_TOKEN@*/true/*@END_MENU_TOKEN@*/)
                                        .isHidden(profile != "tiger" && profile != "üêØ")
                                    )
                            }
                            
                            Spacer().frame(width : 20)
                            
                            Button(action: {
                                profile = "üêµ"
                            }){
                                Text("üêµ")
                                    .font(.largeTitle)
                                    .fontWeight(.semibold)
                                    .padding(5)
                                    .background(Circle()
                                        .strokeBorder(lineWidth: 3, antialiased: /*@START_MENU_TOKEN@*/true/*@END_MENU_TOKEN@*/)
                                        .isHidden(profile != "monkey" && profile != "üêµ")
                                    )
                            }
                            
                            Spacer().frame(width : 20)
                            
                            Button(action: {
                                profile = "üê•"
                            }){
                                Text("üê•")
                                    .font(.largeTitle)
                                    .fontWeight(.semibold)
                                    .padding(5)
                                    .background(Circle()
                                        .strokeBorder(lineWidth: 3, antialiased: /*@START_MENU_TOKEN@*/true/*@END_MENU_TOKEN@*/)
                                        .isHidden(profile != "chick" && profile != "üê•")
                                    )
                            }
                        }
                    }
                    
                    Spacer().frame(height : 40)
                    
                    Group {
                        HStack{
                            Text("ÌîÑÎ°úÌïÑ Î∞∞Í≤Ω ÏÑ§Ï†ï")
                                .font(.caption)
                                .foregroundColor(.gray)
                            
                            Spacer()
                        }
                        
                        Spacer().frame(height : 20)
                        
                        HStack{
                            Button(action: {
                                profile_bg = .sozip_bg_1
                            }){
                                Circle()
                                    .frame(width : 40, height : 40)
                                    .foregroundColor(.sozip_bg_1)
                                    .shadow(radius: 5)
                                    .overlay(Image(systemName : "checkmark")
                                        .foregroundColor(.white)
                                        .isHidden(profile_bg != .sozip_bg_1)
                                    )
                            }
                            
                            Spacer().frame(width : 40)
                            
                            Button(action: {
                                profile_bg = .sozip_bg_2
                            }){
                                Circle()
                                    .frame(width : 40, height : 40)
                                    .foregroundColor(.sozip_bg_2)
                                    .shadow(radius: 5)
                                    .overlay(Image(systemName : "checkmark")
                                        .foregroundColor(.white)
                                        .isHidden(profile_bg != .sozip_bg_2)
                                    )
                            }
                            
                            Spacer().frame(width : 40)
                            
                            Button(action: {
                                profile_bg = .sozip_bg_3
                            }){
                                Circle()
                                    .frame(width : 40, height : 40)
                                    .foregroundColor(.sozip_bg_3)
                                    .shadow(radius: 5)
                                    .overlay(Image(systemName : "checkmark")
                                        .foregroundColor(.white)
                                        .isHidden(profile_bg != .sozip_bg_3)
                                    )
                            }
                            
                            Spacer().frame(width : 40)
                            
                            Button(action: {
                                profile_bg = .sozip_bg_4
                            }){
                                Circle()
                                    .frame(width : 40, height : 40)
                                    .foregroundColor(.sozip_bg_4)
                                    .shadow(radius: 5)
                                    .overlay(Image(systemName : "checkmark")
                                        .foregroundColor(.white)
                                        .isHidden(profile_bg != .sozip_bg_4)
                                    )
                            }
                            
                            Spacer().frame(width : 40)
                            
                            Button(action: {
                                profile_bg = .sozip_bg_5
                            }){
                                Circle()
                                    .frame(width : 40, height : 40)
                                    .foregroundColor(.sozip_bg_5)
                                    .shadow(radius: 5)
                                    .overlay(Image(systemName : "checkmark")
                                        .foregroundColor(.white)
                                        .isHidden(profile_bg != .sozip_bg_5)
                                    )
                            }
                            
                        }
                    }
                    
                    Spacer().frame(height : 20)
                    
                    Group{
                        HStack{
                            Text("Í∞úÏù∏ Ï†ïÎ≥¥ Í¥ÄÎ¶¨")
                                .font(.caption)
                                .foregroundColor(.gray)
                            
                            Spacer()
                        }
                        
                        NavigationLink(destination : changePassword()){
                            HStack{
                                Image(systemName : "key.viewfinder")
                                    .resizable()
                                    .frame(width : 30, height : 30)
                                    .foregroundColor(.txt_color)
                                
                                Text("ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω")
                                    .foregroundColor(.txt_color)
                                
                                Spacer()
                            }.padding(20)        .background(RoundedRectangle(cornerRadius: 15.0)
                                .shadow(radius: 2, x: 0, y: 2)
                                .foregroundColor(.btn_color))
                        }
                        
                        NavigationLink(destination : changeUserInfo()){
                            HStack{
                                Image(systemName : "phone.circle.fill")
                                    .resizable()
                                    .frame(width : 30, height : 30)
                                    .foregroundColor(.txt_color)
                                
                                Text("Ïó∞ÎùΩÏ≤ò Î≥ÄÍ≤Ω")
                                    .foregroundColor(.txt_color)
                                
                                Spacer()

                            }.padding(20).background(RoundedRectangle(cornerRadius: 15.0)
                                .shadow(radius: 2, x: 0, y: 2)
                                .foregroundColor(.btn_color))
                            
                        }
                        
                        NavigationLink(destination : ManageAccountView()){
                            HStack{
                                Image(systemName : "wonsign.circle.fill")
                                    .resizable()
                                    .frame(width : 30, height : 30)
                                    .foregroundColor(.txt_color)
                                
                                Text("Í≥ÑÏ¢å Í¥ÄÎ¶¨")
                                    .foregroundColor(.txt_color)
                                
                                Spacer()

                            }.padding(20).background(RoundedRectangle(cornerRadius: 15.0)
                                .shadow(radius: 2, x: 0, y: 2)
                                .foregroundColor(.btn_color))
                            
                        }
                        
                        Spacer().frame(height : 20)
                        
                        Button(action: {
                            showProcess = true
                            
                            helper.updateProfile(nickName: nickName, bg: profile_bg, profile: profile){result in
                                guard let result = result else{return}
                                
                                if result{
                                    showProcess = false
                                    
                                    alertModel = .updateSuccess
                                    showAlert = true
                                }
                                
                                else{
                                    showProcess = false
                                    
                                    alertModel = .updateFail
                                    showAlert = true
                                }
                            }
                        }){
                            HStack{
                                Text("ÌîÑÎ°úÌïÑ Î≥ÄÍ≤ΩÌïòÍ∏∞")
                                    .foregroundColor(.white)
                                Image(systemName: "chevron.right")
                                    .foregroundColor(.white)
                            }.padding(20)
                                .frame(width : 300)
                                .background(RoundedRectangle(cornerRadius: /*@START_MENU_TOKEN@*/25.0/*@END_MENU_TOKEN@*/).shadow(radius: 5))
                                .isHidden(self.nickName == helper.nickName && helper.profile == self.profile && helper.getColor() == self.profile_bg)
                        }
                        
                        HStack {
                            Button(action : {
                                alertModel = .signOut
                                showAlert = true
                            }){
                                Text("Î°úÍ∑∏ÏïÑÏõÉ")
                                    .font(.caption)
                                    .foregroundColor(.gray)
                                    .underline(true, color : .gray)
                            }
                            
                            Text("ÎòêÎäî")
                                .font(.caption)
                                .foregroundColor(.gray)
                            
                            Button(action : {
                                alertModel = .secession
                                showAlert = true
                            }){
                                Text("ÌöåÏõê ÌÉàÌá¥")
                                    .font(.caption)
                                    .foregroundColor(.gray)
                                    .underline(/*@START_MENU_TOKEN@*/true/*@END_MENU_TOKEN@*/, color: .gray)
                            }
                        }
                    }
                    
                    
                }.padding(20)
                    .onAppear(perform: {
                        nickName = helper.nickName
                        profile = helper.getProfile()
                        profile_bg = helper.getColor()
                    })
                
                    .navigationBarTitle("ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥ Î≥ÄÍ≤Ω", displayMode: .inline)
                
                    .fullScreenCover(isPresented: $showSignInScreen, content: {
                        SignInView(helper : UserManagement())
                    })
                
                    .overlay(ProcessView().isHidden(!showProcess))
                
                    .alert(item: $alertModel){item in
                        switch(item){
                        case .signOut:
                            return Alert(title: Text("Î°úÍ∑∏ÏïÑÏõÉ"),
                                         message: Text("Î°úÍ∑∏ÏïÑÏõÉ Ïãú ÏûêÎèô Î°úÍ∑∏Ïù∏Ïù¥ Ìï¥Ï†úÎêòÎ©∞, Îã§Ïãú Î°úÍ∑∏Ïù∏ÌïòÏÖîÏïº Ìï©ÎãàÎã§.\nÍ≥ÑÏÜç ÌïòÏãúÍ≤†ÏäµÎãàÍπå?"),
                                         primaryButton: .default(Text("Ïòà")){
                                showProcess = true
                                
                                helper.signOut(){result in
                                    guard let result = result else{return}
                                    
                                    if result{
                                        showProcess = false
                                        
                                        self.showSignInScreen = true
                                    }
                                    
                                    else{
                                        showProcess = false
                                        
                                        alertModel = .signOutFail
                                    }
                                }
                            }, secondaryButton: .default(Text("ÏïÑÎãàÏò§")))
                            
                        case .secession:
                            return Alert(title: Text("ÌöåÏõê ÌÉàÌá¥ ÏïàÎÇ¥"),
                                         message: Text("ÌöåÏõê ÌÉàÌá¥ Ïãú Î™®Îì† Í∞ÄÏûÖ Ï†ïÎ≥¥Í∞Ä Ï†úÍ±∞ÎêòÎ©∞, Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.\nÍ≥ÑÏÜç ÌïòÏãúÍ≤†ÏäµÎãàÍπå?"),
                                         primaryButton: .default(Text("Ïòà")){
                                showProcess = true
                                
                                helper.secession(){result in
                                    guard let result = result else{return}
                                    
                                    if result == "success"{
                                        showProcess = false
                                        
                                        alertModel = .greet
                                    }
                                    
                                    else if result == "noUser"{
                                        showProcess = false
                                        
                                        alertModel = .noUser
                                    }
                                    
                                    else{
                                        showProcess = false
                                        
                                        alertModel = .secessionFail
                                    }
                                }
                            },
                                         secondaryButton: .default(Text("ÏïÑÎãàÏò§")){
                                
                            })
                        case .greet:
                            return Alert(title: Text("Í∞êÏÇ¨ Ïù∏ÏÇ¨"),
                                         message: Text("ÌöåÏõê ÌÉàÌá¥Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.\nÎçî ÎÇòÏùÄ ÏÑúÎπÑÏä§Î°ú Îã§Ïãú ÎßåÎÇ† Ïàò ÏûàÎèÑÎ°ù ÎÖ∏Î†•ÌïòÍ≤†ÏäµÎãàÎã§.\nÍ∑∏ ÎèôÏïà ÏÑúÎπÑÏä§Î•º Ïù¥Ïö©Ìï¥Ï£ºÏÖîÏÑú Í∞êÏÇ¨Ìï©ÎãàÎã§."),
                                         dismissButton: .default(Text("ÌôïÏù∏")){
                                showProcess = false
                                
                                self.showSignInScreen = true
                            })
                            
                        case .secessionFail:
                            return Alert(title: Text("Ïò§Î•ò"), message: Text("ÌöåÏõê ÌÉàÌá¥ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\nÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÍ±∞ÎÇò ÎÇòÏ§ëÏóê Îã§Ïãú ÏãúÎèÑÌïòÏã≠ÏãúÏò§."), dismissButton: .default(Text("ÌôïÏù∏")))
                            
                        case .noUser:
                            return Alert(title: Text("ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏóÜÏùå"),
                                         message: Text("ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.\nÎ°úÍ∑∏Ïù∏ ÌôîÎ©¥ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§."),
                                         dismissButton: .default(Text("ÌôïÏù∏")){self.showSignInScreen = true})
                            
                        case .signOutFail:
                            return Alert(title: Text("Ïò§Î•ò"), message: Text("Î°úÍ∑∏ÏïÑÏõÉ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\nÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÍ±∞ÎÇò ÎÇòÏ§ëÏóê Îã§Ïãú ÏãúÎèÑÌïòÏã≠ÏãúÏò§."), dismissButton: .default(Text("ÌôïÏù∏")){self.showSignInScreen = true})
                            
                        case .updateSuccess:
                            return Alert(title: Text("ÌîÑÎ°úÌïÑ Î≥ÄÍ≤Ω ÏôÑÎ£å"), message: Text("ÌîÑÎ°úÌïÑÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏñ¥Ïöî!"), dismissButton: .default(Text("ÌôïÏù∏")))
                            
                        case .updateFail:
                            return Alert(title: Text("ÌîÑÎ°úÌïÑ Î≥ÄÍ≤Ω Ïò§Î•ò"), message: Text("ÏöîÏ≤≠ ÏÇ¨Ìï≠ÏùÑ Ï≤òÎ¶¨ÌïòÎäî Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\nÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÍ±∞ÎÇò ÎÇòÏ§ëÏóê Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî."), dismissButton: .default(Text("ÌôïÏù∏")))
                        }
                    }
            }

        }
    }
}

struct editProfile_Previews: PreviewProvider {
    static var previews: some View {
        editProfileView()
    }
}
